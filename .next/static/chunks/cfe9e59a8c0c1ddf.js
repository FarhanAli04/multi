(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,73518,e=>{"use strict";var t=e.i(47167),r=e.i(43476),s=e.i(71645);class a extends Error{}a.prototype.name="InvalidTokenError";let n={user:null,token:localStorage.getItem("token"),isAuthenticated:!1,isLoading:!0,error:null},o="LOGIN_START",i="LOGIN_SUCCESS",l="LOGIN_FAILURE",c="LOGOUT",d="REGISTER_START",u="REGISTER_SUCCESS",h="REGISTER_FAILURE",g="LOAD_USER_SUCCESS",p="LOAD_USER_FAILURE",f="CLEAR_ERROR",m=(e,t)=>{switch(t.type){case o:case d:return{...e,isLoading:!0,error:null};case i:case u:return{...e,user:t.payload.user,token:t.payload.token,isAuthenticated:!0,isLoading:!1,error:null};case l:case h:case p:return{...e,user:null,token:null,isAuthenticated:!1,isLoading:!1,error:t.payload};case c:return{...e,user:null,token:null,isAuthenticated:!1,isLoading:!1,error:null};case"LOAD_USER":return{...e,isLoading:!0};case g:return{...e,user:t.payload,isAuthenticated:!0,isLoading:!1};case f:return{...e,error:null};default:return e}},y=(0,s.createContext)();e.s(["AuthProvider",0,({children:e})=>{let[b,x]=(0,s.useReducer)(m,n),_=t.default.env.REACT_APP_API_URL||"http://localhost:8000/api";(0,s.useEffect)(()=>{(async()=>{let e=localStorage.getItem("token");if(!e)return x({type:p,payload:"No token found"});try{let t=function(e,t){let r;if("string"!=typeof e)throw new a("Invalid token specified: must be a string");t||(t={});let s=+(!0!==t.header),n=e.split(".")[s];if("string"!=typeof n)throw new a(`Invalid token specified: missing part #${s+1}`);try{r=function(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw Error("base64 string is not of the correct length")}try{var r;return r=t,decodeURIComponent(atob(r).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}catch(e){return atob(t)}}(n)}catch(e){throw new a(`Invalid token specified: invalid base64 for part #${s+1} (${e.message})`)}try{return JSON.parse(r)}catch(e){throw new a(`Invalid token specified: invalid json for part #${s+1} (${e.message})`)}}(e);if(1e3*t.exp<Date.now()){localStorage.removeItem("token"),x({type:p,payload:"Token expired"});return}let r=await fetch(`${_}/auth/me`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)throw Error("Failed to load user");let s=await r.json();if(s.success)x({type:g,payload:s.user});else throw Error(s.error||"Failed to load user")}catch(e){localStorage.removeItem("token"),x({type:p,payload:e.message})}})()},[]);let v=async(e,t)=>{x({type:o});try{let r=await fetch(`${_}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),s=await r.json();if(s.success)return localStorage.setItem("token",s.token),x({type:i,payload:{user:s.user,token:s.token}}),{success:!0};throw Error(s.error||"Login failed")}catch(e){return x({type:l,payload:e.message}),{success:!1,error:e.message}}},S=async e=>{x({type:d});try{let t=await fetch(`${_}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(r.success)return localStorage.setItem("token",r.token),x({type:u,payload:{user:r.user,token:r.token}}),{success:!0};throw Error(r.error||"Registration failed")}catch(e){return x({type:h,payload:e.message}),{success:!1,error:e.message}}},k={...b,login:v,register:S,logout:()=>{localStorage.removeItem("token"),x({type:c})},clearError:()=>{x({type:f})}};return(0,r.jsx)(y.Provider,{value:k,children:e})},"useAuth",0,()=>{let e=(0,s.useContext)(y);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}],73518)},41222,e=>{"use strict";var t=e.i(47167),r=e.i(43476),s=e.i(71645),a=e.i(73518);function n(){let{user:e}=(0,a.useAuth)(),{isConnected:n,messages:o,sendMessage:i,sendTyping:l,markAsRead:c,onlineUsers:d}=(()=>{let{token:e,user:r}=(0,a.useAuth)(),[n,o]=(0,s.useState)(null),[i,l]=(0,s.useState)(!1),[c,d]=(0,s.useState)([]),[u,h]=(0,s.useState)([]),[g,p]=(0,s.useState)(new Set),[f,m]=(0,s.useState)(new Set),y=(0,s.useRef)(null),b=(0,s.useRef)(0),x=t.default.env.REACT_APP_WS_URL||"ws://localhost:8080",_=(0,s.useCallback)(()=>{if(e)try{let t=new WebSocket(`${x}?token=${e}`);t.onopen=()=>{console.log("WebSocket connected"),l(!0),o(t),b.current=0},t.onmessage=e=>{let t=JSON.parse(e.data);switch(t.type){case"connection_established":console.log("Connection established with user:",t.user_id);break;case"message":d(e=>[...e,t]);break;case"typing":t.is_typing?p(e=>new Set(e).add(t.user_id)):p(e=>{let r=new Set(e);return r.delete(t.user_id),r});break;case"read_receipt":d(e=>e.map(e=>e.id===t.message_id?{...e,is_read:!0,read_at:t.read_at}:e));break;case"user_status":t.is_online?m(e=>new Set(e).add(t.user_id)):m(e=>{let r=new Set(e);return r.delete(t.user_id),r});break;case"error":console.error("WebSocket error:",t.message);break;default:console.log("Unknown message type:",t.type)}},t.onclose=()=>{console.log("WebSocket disconnected"),l(!1),o(null),b.current<5&&(y.current=setTimeout(()=>{b.current++,console.log(`Attempting to reconnect (${b.current}/5)`),_()},3e3))},t.onerror=e=>{console.error("WebSocket error:",e),l(!1)}}catch(e){console.error("Failed to connect to WebSocket:",e)}},[e,x]),v=(0,s.useCallback)(()=>{y.current&&clearTimeout(y.current),n&&n.close(),l(!1),o(null),b.current=0},[n]),S=(0,s.useCallback)((e,t,r="text")=>n&&i?(n.send(JSON.stringify({type:"message",conversation_id:e,content:t,message_type:r})),!0):(console.error("WebSocket not connected"),!1),[n,i]),k=(0,s.useCallback)((e,t)=>{n&&i&&n.send(JSON.stringify({type:"typing",conversation_id:e,is_typing:t}))},[n,i]),w=(0,s.useCallback)(e=>{n&&i&&n.send(JSON.stringify({type:"read_receipt",message_id:e}))},[n,i]),j=(0,s.useCallback)(e=>{n&&i&&n.send(JSON.stringify({type:"user_status",is_online:e}))},[n,i]);return(0,s.useEffect)(()=>(e&&r?_():v(),()=>{v()}),[e,r,_,v]),(0,s.useEffect)(()=>(i&&r&&j(!0),()=>{r&&j(!1)}),[i,r,j]),(0,s.useEffect)(()=>()=>{v()},[v]),{socket:n,isConnected:i,messages:c,setMessages:d,conversations:u,setConversations:h,typingUsers:g,onlineUsers:f,sendMessage:S,sendTyping:k,markAsRead:w,updateStatus:j,connect:_,disconnect:v}})(),[u,h]=(0,s.useState)([]),[g,p]=(0,s.useState)(null),[f,m]=(0,s.useState)(""),[y,b]=(0,s.useState)(!1),x=(0,s.useRef)(null),_=(0,s.useRef)(null),v=t.default.env.NEXT_PUBLIC_API_URL||"http://localhost:8000/api";(0,s.useEffect)(()=>{let t=async()=>{try{let e=localStorage.getItem("token"),t=await fetch(`${v}/conversations`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(t.ok){let e=await t.json();h(e.conversations||[])}}catch(e){console.error("Failed to fetch conversations:",e)}};e&&t()},[e,v]),(0,s.useEffect)(()=>{x.current?.scrollIntoView({behavior:"smooth"})},[o]);let S=async e=>{p(e);try{let t=localStorage.getItem("token"),r=await fetch(`${v}/conversations/${e.conversation_id}/messages`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(r.ok){let e=await r.json();console.log("Fetched messages:",e.messages)}}catch(e){console.error("Failed to fetch messages:",e)}};return e?(0,r.jsxs)("div",{className:"flex h-screen border border-gray-300",children:[(0,r.jsxs)("div",{className:"w-80 border-r border-gray-300 overflow-y-auto",children:[(0,r.jsxs)("div",{className:"p-4 border-b border-gray-300 font-bold flex justify-between items-center",children:["Conversations",(0,r.jsx)("span",{className:`text-sm ${n?"text-green-500":"text-red-500"}`,children:n?"Online":"Offline"})]}),u.map(e=>(0,r.jsxs)("div",{onClick:()=>S(e),className:`p-4 border-b border-gray-200 cursor-pointer ${g?.conversation_id===e.conversation_id?"bg-gray-100":"bg-white"}`,children:[(0,r.jsxs)("div",{className:"font-bold flex justify-between items-center",children:[e.other_user_name,(0,r.jsx)("span",{className:`text-sm ${d.has(e.other_user_id)?"text-green-500":"text-gray-500"}`,children:d.has(e.other_user_id)?"Online":"Offline"})]}),(0,r.jsx)("div",{className:"text-sm text-gray-600 truncate",children:e.last_message||"No messages yet"}),e.unread_count>0&&(0,r.jsx)("div",{className:"inline-flex items-center justify-center w-5 h-5 bg-red-500 text-white rounded-full text-xs mt-2",children:e.unread_count})]},e.conversation_id))]}),(0,r.jsx)("div",{className:"flex-1 flex flex-col",children:g?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"p-4 border-b border-gray-300 font-bold flex justify-between items-center",children:(0,r.jsxs)("div",{children:[g.other_user_name,(0,r.jsx)("span",{className:`text-sm ml-2 ${d.has(g.other_user_id)?"text-green-500":"text-gray-500"}`,children:d.has(g.other_user_id)?"Online":"Offline"})]})}),(0,r.jsxs)("div",{className:"flex-1 p-4 overflow-y-auto bg-gray-50",children:[o.map(t=>(0,r.jsx)("div",{className:`mb-3 flex ${t.sender_id===e?.id?"justify-end":"justify-start"}`,children:(0,r.jsxs)("div",{className:`max-w-xs px-3 py-2 rounded-2xl ${t.sender_id===e?.id?"bg-blue-500 text-white":"bg-gray-200 text-black"}`,children:[(0,r.jsx)("div",{children:t.content}),(0,r.jsx)("div",{className:"text-xs opacity-70 mt-1",children:new Date(t.created_at).toLocaleTimeString()})]})},t.id)),(0,r.jsx)("div",{ref:x})]}),(0,r.jsxs)("form",{onSubmit:e=>{e.preventDefault(),!f.trim()||!g||i(g.conversation_id,f.trim())&&(m(""),b(!1),g&&l(g.conversation_id,!1))},className:"p-4 border-t border-gray-300 flex",children:[(0,r.jsx)("input",{type:"text",value:f,onChange:e=>{var t;m(t=e.target.value),!y&&t.length>0&&(b(!0),g&&l(g.conversation_id,!0)),0===t.length&&(b(!1),g&&l(g.conversation_id,!1)),_.current&&clearTimeout(_.current),_.current=setTimeout(()=>{b(!1),g&&l(g.conversation_id,!1)},1e3)},placeholder:"Type a message...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-full mr-2"}),(0,r.jsx)("button",{type:"submit",disabled:!f.trim()||!n,className:`px-4 py-2 rounded-full text-white ${n?"bg-blue-500 hover:bg-blue-600":"bg-gray-400 cursor-not-allowed"}`,children:"Send"})]})]}):(0,r.jsx)("div",{className:"flex items-center justify-center h-full text-gray-600",children:"Select a conversation to start chatting"})})]}):(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsx)("div",{children:"Please login to access chat"})})}function o(){return(0,r.jsx)(a.AuthProvider,{children:(0,r.jsx)(n,{})})}e.s(["default",()=>o],41222)}]);