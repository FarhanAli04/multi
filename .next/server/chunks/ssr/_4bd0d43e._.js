module.exports=[49975,a=>{"use strict";var b=a.i(87924),c=a.i(72131);class d extends Error{}d.prototype.name="InvalidTokenError";let e={user:null,token:null,isAuthenticated:!1,isLoading:!0,error:null},f="LOGIN_START",g="LOGIN_SUCCESS",h="LOGIN_FAILURE",i="LOGOUT",j="REGISTER_START",k="REGISTER_SUCCESS",l="REGISTER_FAILURE",m="LOAD_USER_SUCCESS",n="LOAD_USER_FAILURE",o="CLEAR_ERROR",p=(a,b)=>{switch(b.type){case f:case j:return{...a,isLoading:!0,error:null};case g:case k:return{...a,user:b.payload.user,token:b.payload.token,isAuthenticated:!0,isLoading:!1,error:null};case h:case l:case n:return{...a,user:null,token:null,isAuthenticated:!1,isLoading:!1,error:b.payload};case i:return{...a,user:null,token:null,isAuthenticated:!1,isLoading:!1,error:null};case"LOAD_USER":return{...a,isLoading:!0};case m:return{...a,user:b.payload,isAuthenticated:!0,isLoading:!1};case o:return{...a,error:null};default:return a}},q=(0,c.createContext)();a.s(["AuthProvider",0,({children:a})=>{let[r,s]=(0,c.useReducer)(p,e),t=process.env.REACT_APP_API_URL||"http://localhost:8000/api";(0,c.useEffect)(()=>{(async()=>{let a=localStorage.getItem("token");if(!a)return s({type:n,payload:"No token found"});try{let b=function(a,b){let c;if("string"!=typeof a)throw new d("Invalid token specified: must be a string");b||(b={});let e=+(!0!==b.header),f=a.split(".")[e];if("string"!=typeof f)throw new d(`Invalid token specified: missing part #${e+1}`);try{c=function(a){let b=a.replace(/-/g,"+").replace(/_/g,"/");switch(b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw Error("base64 string is not of the correct length")}try{var c;return c=b,decodeURIComponent(atob(c).replace(/(.)/g,(a,b)=>{let c=b.charCodeAt(0).toString(16).toUpperCase();return c.length<2&&(c="0"+c),"%"+c}))}catch(a){return atob(b)}}(f)}catch(a){throw new d(`Invalid token specified: invalid base64 for part #${e+1} (${a.message})`)}try{return JSON.parse(c)}catch(a){throw new d(`Invalid token specified: invalid json for part #${e+1} (${a.message})`)}}(a);if(1e3*b.exp<Date.now()){localStorage.removeItem("token"),s({type:n,payload:"Token expired"});return}let c=await fetch(`${t}/auth/me`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(!c.ok)throw Error("Failed to load user");let e=await c.json();if(e.success)s({type:m,payload:e.user});else throw Error(e.error||"Failed to load user")}catch(a){localStorage.removeItem("token"),s({type:n,payload:a.message})}})()},[]);let u=async(a,b)=>{s({type:f});try{let c=await fetch(`${t}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,password:b})}),d=await c.json();if(d.success)return localStorage.setItem("token",d.token),s({type:g,payload:{user:d.user,token:d.token}}),{success:!0};throw Error(d.error||"Login failed")}catch(a){return s({type:h,payload:a.message}),{success:!1,error:a.message}}},v=async a=>{s({type:j});try{let b=await fetch(`${t}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),c=await b.json();if(c.success)return localStorage.setItem("token",c.token),s({type:k,payload:{user:c.user,token:c.token}}),{success:!0};throw Error(c.error||"Registration failed")}catch(a){return s({type:l,payload:a.message}),{success:!1,error:a.message}}},w={...r,login:u,register:v,logout:()=>{localStorage.removeItem("token"),s({type:i})},clearError:()=>{s({type:o})}};return(0,b.jsx)(q.Provider,{value:w,children:a})},"useAuth",0,()=>{let a=(0,c.useContext)(q);if(!a)throw Error("useAuth must be used within an AuthProvider");return a}],49975)},52763,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(49975);function e(){let{user:a}=(0,d.useAuth)(),{isConnected:e,messages:f,sendMessage:g,sendTyping:h,markAsRead:i,onlineUsers:j}=(()=>{let{token:a,user:b}=(0,d.useAuth)(),[e,f]=(0,c.useState)(null),[g,h]=(0,c.useState)(!1),[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)([]),[m,n]=(0,c.useState)(new Set),[o,p]=(0,c.useState)(new Set),q=(0,c.useRef)(null),r=(0,c.useRef)(0),s=process.env.REACT_APP_WS_URL||"ws://localhost:8080",t=(0,c.useCallback)(()=>{if(a)try{let b=new WebSocket(`${s}?token=${a}`);b.onopen=()=>{console.log("WebSocket connected"),h(!0),f(b),r.current=0},b.onmessage=a=>{let b=JSON.parse(a.data);switch(b.type){case"connection_established":console.log("Connection established with user:",b.user_id);break;case"message":j(a=>[...a,b]);break;case"typing":b.is_typing?n(a=>new Set(a).add(b.user_id)):n(a=>{let c=new Set(a);return c.delete(b.user_id),c});break;case"read_receipt":j(a=>a.map(a=>a.id===b.message_id?{...a,is_read:!0,read_at:b.read_at}:a));break;case"user_status":b.is_online?p(a=>new Set(a).add(b.user_id)):p(a=>{let c=new Set(a);return c.delete(b.user_id),c});break;case"error":console.error("WebSocket error:",b.message);break;default:console.log("Unknown message type:",b.type)}},b.onclose=()=>{console.log("WebSocket disconnected"),h(!1),f(null),r.current<5&&(q.current=setTimeout(()=>{r.current++,console.log(`Attempting to reconnect (${r.current}/5)`),t()},3e3))},b.onerror=a=>{console.error("WebSocket error:",a),h(!1)}}catch(a){console.error("Failed to connect to WebSocket:",a)}},[a,s]),u=(0,c.useCallback)(()=>{q.current&&clearTimeout(q.current),e&&e.close(),h(!1),f(null),r.current=0},[e]),v=(0,c.useCallback)((a,b,c="text")=>e&&g?(e.send(JSON.stringify({type:"message",conversation_id:a,content:b,message_type:c})),!0):(console.error("WebSocket not connected"),!1),[e,g]),w=(0,c.useCallback)((a,b)=>{e&&g&&e.send(JSON.stringify({type:"typing",conversation_id:a,is_typing:b}))},[e,g]),x=(0,c.useCallback)(a=>{e&&g&&e.send(JSON.stringify({type:"read_receipt",message_id:a}))},[e,g]),y=(0,c.useCallback)(a=>{e&&g&&e.send(JSON.stringify({type:"user_status",is_online:a}))},[e,g]);return(0,c.useEffect)(()=>(a&&b?t():u(),()=>{u()}),[a,b,t,u]),(0,c.useEffect)(()=>(g&&b&&y(!0),()=>{b&&y(!1)}),[g,b,y]),(0,c.useEffect)(()=>()=>{u()},[u]),{socket:e,isConnected:g,messages:i,setMessages:j,conversations:k,setConversations:l,typingUsers:m,onlineUsers:o,sendMessage:v,sendTyping:w,markAsRead:x,updateStatus:y,connect:t,disconnect:u}})(),[k,l]=(0,c.useState)([]),[m,n]=(0,c.useState)(null),[o,p]=(0,c.useState)(""),[q,r]=(0,c.useState)(!1),s=(0,c.useRef)(null),t=(0,c.useRef)(null),u=process.env.NEXT_PUBLIC_API_URL||"http://localhost:8000/api";(0,c.useEffect)(()=>{let b=async()=>{try{let a=localStorage.getItem("token"),b=await fetch(`${u}/conversations`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(b.ok){let a=await b.json();l(a.conversations||[])}}catch(a){console.error("Failed to fetch conversations:",a)}};a&&b()},[a,u]),(0,c.useEffect)(()=>{s.current?.scrollIntoView({behavior:"smooth"})},[f]);let v=async a=>{n(a);try{let b=localStorage.getItem("token"),c=await fetch(`${u}/conversations/${a.conversation_id}/messages`,{headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"}});if(c.ok){let a=await c.json();console.log("Fetched messages:",a.messages)}}catch(a){console.error("Failed to fetch messages:",a)}};return a?(0,b.jsxs)("div",{className:"flex h-screen border border-gray-300",children:[(0,b.jsxs)("div",{className:"w-80 border-r border-gray-300 overflow-y-auto",children:[(0,b.jsxs)("div",{className:"p-4 border-b border-gray-300 font-bold flex justify-between items-center",children:["Conversations",(0,b.jsx)("span",{className:`text-sm ${e?"text-green-500":"text-red-500"}`,children:e?"Online":"Offline"})]}),k.map(a=>(0,b.jsxs)("div",{onClick:()=>v(a),className:`p-4 border-b border-gray-200 cursor-pointer ${m?.conversation_id===a.conversation_id?"bg-gray-100":"bg-white"}`,children:[(0,b.jsxs)("div",{className:"font-bold flex justify-between items-center",children:[a.other_user_name,(0,b.jsx)("span",{className:`text-sm ${j.has(a.other_user_id)?"text-green-500":"text-gray-500"}`,children:j.has(a.other_user_id)?"Online":"Offline"})]}),(0,b.jsx)("div",{className:"text-sm text-gray-600 truncate",children:a.last_message||"No messages yet"}),a.unread_count>0&&(0,b.jsx)("div",{className:"inline-flex items-center justify-center w-5 h-5 bg-red-500 text-white rounded-full text-xs mt-2",children:a.unread_count})]},a.conversation_id))]}),(0,b.jsx)("div",{className:"flex-1 flex flex-col",children:m?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"p-4 border-b border-gray-300 font-bold flex justify-between items-center",children:(0,b.jsxs)("div",{children:[m.other_user_name,(0,b.jsx)("span",{className:`text-sm ml-2 ${j.has(m.other_user_id)?"text-green-500":"text-gray-500"}`,children:j.has(m.other_user_id)?"Online":"Offline"})]})}),(0,b.jsxs)("div",{className:"flex-1 p-4 overflow-y-auto bg-gray-50",children:[f.map(c=>(0,b.jsx)("div",{className:`mb-3 flex ${c.sender_id===a?.id?"justify-end":"justify-start"}`,children:(0,b.jsxs)("div",{className:`max-w-xs px-3 py-2 rounded-2xl ${c.sender_id===a?.id?"bg-blue-500 text-white":"bg-gray-200 text-black"}`,children:[(0,b.jsx)("div",{children:c.content}),(0,b.jsx)("div",{className:"text-xs opacity-70 mt-1",children:new Date(c.created_at).toLocaleTimeString()})]})},c.id)),(0,b.jsx)("div",{ref:s})]}),(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),!o.trim()||!m||g(m.conversation_id,o.trim())&&(p(""),r(!1),m&&h(m.conversation_id,!1))},className:"p-4 border-t border-gray-300 flex",children:[(0,b.jsx)("input",{type:"text",value:o,onChange:a=>{var b;p(b=a.target.value),!q&&b.length>0&&(r(!0),m&&h(m.conversation_id,!0)),0===b.length&&(r(!1),m&&h(m.conversation_id,!1)),t.current&&clearTimeout(t.current),t.current=setTimeout(()=>{r(!1),m&&h(m.conversation_id,!1)},1e3)},placeholder:"Type a message...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-full mr-2"}),(0,b.jsx)("button",{type:"submit",disabled:!o.trim()||!e,className:`px-4 py-2 rounded-full text-white ${e?"bg-blue-500 hover:bg-blue-600":"bg-gray-400 cursor-not-allowed"}`,children:"Send"})]})]}):(0,b.jsx)("div",{className:"flex items-center justify-center h-full text-gray-600",children:"Select a conversation to start chatting"})})]}):(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsx)("div",{children:"Please login to access chat"})})}function f(){return(0,b.jsx)(d.AuthProvider,{children:(0,b.jsx)(e,{})})}a.s(["default",()=>f],52763)}];

//# sourceMappingURL=_4bd0d43e._.js.map