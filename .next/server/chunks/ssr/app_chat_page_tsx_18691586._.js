module.exports=[52763,a=>{"use strict";var b=a.i(87924),c=a.i(72131);class d extends Error{}d.prototype.name="InvalidTokenError";let e={user:null,token:null,isAuthenticated:!1,isLoading:!0,error:null},f="LOGIN_START",g="LOGIN_SUCCESS",h="LOGIN_FAILURE",i="LOGOUT",j="REGISTER_START",k="REGISTER_SUCCESS",l="REGISTER_FAILURE",m="LOAD_USER_SUCCESS",n="LOAD_USER_FAILURE",o="CLEAR_ERROR",p=(a,b)=>{switch(b.type){case f:case j:return{...a,isLoading:!0,error:null};case g:case k:return{...a,user:b.payload.user,token:b.payload.token,isAuthenticated:!0,isLoading:!1,error:null};case h:case l:case n:return{...a,user:null,token:null,isAuthenticated:!1,isLoading:!1,error:b.payload};case i:return{...a,user:null,token:null,isAuthenticated:!1,isLoading:!1,error:null};case"LOAD_USER":return{...a,isLoading:!0};case m:return{...a,user:b.payload,isAuthenticated:!0,isLoading:!1};case o:return{...a,error:null};default:return a}},q=(0,c.createContext)(),r=({children:a})=>{let[r,s]=(0,c.useReducer)(p,e),t="http://localhost/sarstore-api",u=t.endsWith("/api")?t:`${t}/api`;(0,c.useEffect)(()=>{(async()=>{let a=localStorage.getItem("token");if(!a)return s({type:n,payload:"No token found"});try{let b=function(a,b){let c;if("string"!=typeof a)throw new d("Invalid token specified: must be a string");b||(b={});let e=+(!0!==b.header),f=a.split(".")[e];if("string"!=typeof f)throw new d(`Invalid token specified: missing part #${e+1}`);try{c=function(a){let b=a.replace(/-/g,"+").replace(/_/g,"/");switch(b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw Error("base64 string is not of the correct length")}try{var c;return c=b,decodeURIComponent(atob(c).replace(/(.)/g,(a,b)=>{let c=b.charCodeAt(0).toString(16).toUpperCase();return c.length<2&&(c="0"+c),"%"+c}))}catch(a){return atob(b)}}(f)}catch(a){throw new d(`Invalid token specified: invalid base64 for part #${e+1} (${a.message})`)}try{return JSON.parse(c)}catch(a){throw new d(`Invalid token specified: invalid json for part #${e+1} (${a.message})`)}}(a);if(1e3*b.exp<Date.now()){localStorage.removeItem("token"),s({type:n,payload:"Token expired"});return}let c=await fetch(`${u}/auth/me`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(!c.ok)throw Error("Failed to load user");let e=await c.json();if(e.success)s({type:m,payload:e.user});else throw Error(e.error||"Failed to load user")}catch(a){localStorage.removeItem("token"),s({type:n,payload:a.message})}})()},[]);let v=async(a,b)=>{s({type:f});try{let c=await fetch(`${u}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,password:b})}),d=await c.json();if(d.success)return localStorage.setItem("token",d.token),s({type:g,payload:{user:d.user,token:d.token}}),{success:!0};throw Error(d.error||"Login failed")}catch(a){return s({type:h,payload:a.message}),{success:!1,error:a.message}}},w=async a=>{s({type:j});try{let b=await fetch(`${u}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),c=await b.json();if(c.success)return localStorage.setItem("token",c.token),s({type:k,payload:{user:c.user,token:c.token}}),{success:!0};throw Error(c.error||"Registration failed")}catch(a){return s({type:l,payload:a.message}),{success:!1,error:a.message}}},x={...r,login:v,register:w,logout:()=>{localStorage.removeItem("token"),s({type:i})},clearError:()=>{s({type:o})}};return(0,b.jsx)(q.Provider,{value:x,children:a})},s=()=>{let a=(0,c.useContext)(q);if(!a)throw Error("useAuth must be used within an AuthProvider");return a};function t(){let{user:a}=s(),{isConnected:d,messages:e,sendMessage:f,sendTyping:g,markAsRead:h,onlineUsers:i}=(()=>{let{token:a,user:b}=s(),[d,e]=(0,c.useState)(null),[f,g]=(0,c.useState)(!1),[h,i]=(0,c.useState)([]),[j,k]=(0,c.useState)([]),[l,m]=(0,c.useState)(new Set),[n,o]=(0,c.useState)(new Set),p=(0,c.useRef)(null),q=(0,c.useRef)(0),r=process.env.REACT_APP_WS_URL||"ws://localhost:8080",t=(0,c.useCallback)(()=>{if(a)try{let b=new WebSocket(`${r}?token=${a}`);b.onopen=()=>{console.log("WebSocket connected"),g(!0),e(b),q.current=0},b.onmessage=a=>{let b=JSON.parse(a.data);switch(b.type){case"connection_established":console.log("Connection established with user:",b.user_id);break;case"message":i(a=>[...a,b]);break;case"typing":b.is_typing?m(a=>new Set(a).add(b.user_id)):m(a=>{let c=new Set(a);return c.delete(b.user_id),c});break;case"read_receipt":i(a=>a.map(a=>a.id===b.message_id?{...a,is_read:!0,read_at:b.read_at}:a));break;case"user_status":b.is_online?o(a=>new Set(a).add(b.user_id)):o(a=>{let c=new Set(a);return c.delete(b.user_id),c});break;case"error":console.error("WebSocket error:",b.message);break;default:console.log("Unknown message type:",b.type)}},b.onclose=()=>{console.log("WebSocket disconnected"),g(!1),e(null),q.current<5&&(p.current=setTimeout(()=>{q.current++,console.log(`Attempting to reconnect (${q.current}/5)`),t()},3e3))},b.onerror=a=>{console.error("WebSocket error:",a),g(!1)}}catch(a){console.error("Failed to connect to WebSocket:",a)}},[a,r]),u=(0,c.useCallback)(()=>{p.current&&clearTimeout(p.current),d&&d.close(),g(!1),e(null),q.current=0},[d]),v=(0,c.useCallback)((a,b,c="text")=>d&&f?(d.send(JSON.stringify({type:"message",conversation_id:a,content:b,message_type:c})),!0):(console.error("WebSocket not connected"),!1),[d,f]),w=(0,c.useCallback)((a,b)=>{d&&f&&d.send(JSON.stringify({type:"typing",conversation_id:a,is_typing:b}))},[d,f]),x=(0,c.useCallback)(a=>{d&&f&&d.send(JSON.stringify({type:"read_receipt",message_id:a}))},[d,f]),y=(0,c.useCallback)(a=>{d&&f&&d.send(JSON.stringify({type:"user_status",is_online:a}))},[d,f]);return(0,c.useEffect)(()=>(a&&b?t():u(),()=>{u()}),[a,b,t,u]),(0,c.useEffect)(()=>(f&&b&&y(!0),()=>{b&&y(!1)}),[f,b,y]),(0,c.useEffect)(()=>()=>{u()},[u]),{socket:d,isConnected:f,messages:h,setMessages:i,conversations:j,setConversations:k,typingUsers:l,onlineUsers:n,sendMessage:v,sendTyping:w,markAsRead:x,updateStatus:y,connect:t,disconnect:u}})(),[j,k]=(0,c.useState)([]),[l,m]=(0,c.useState)(null),[n,o]=(0,c.useState)(""),[p,q]=(0,c.useState)(!1),r=(0,c.useRef)(null),t=(0,c.useRef)(null),u="http://localhost/sarstore-api";(0,c.useEffect)(()=>{let b=async()=>{try{let a=localStorage.getItem("token"),b=await fetch(`${u}/conversations`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(b.ok){let a=await b.json();k(a.conversations||[])}}catch(a){console.error("Failed to fetch conversations:",a)}};a&&b()},[a,u]),(0,c.useEffect)(()=>{r.current?.scrollIntoView({behavior:"smooth"})},[e]);let v=async a=>{m(a);try{let b=localStorage.getItem("token"),c=await fetch(`${u}/conversations/${a.conversation_id}/messages`,{headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"}});if(c.ok){let a=await c.json();console.log("Fetched messages:",a.messages)}}catch(a){console.error("Failed to fetch messages:",a)}};return a?(0,b.jsxs)("div",{className:"flex h-screen border border-gray-300",children:[(0,b.jsxs)("div",{className:"w-80 border-r border-gray-300 overflow-y-auto",children:[(0,b.jsxs)("div",{className:"p-4 border-b border-gray-300 font-bold flex justify-between items-center",children:["Conversations",(0,b.jsx)("span",{className:`text-sm ${d?"text-green-500":"text-red-500"}`,children:d?"Online":"Offline"})]}),j.map(a=>(0,b.jsxs)("div",{onClick:()=>v(a),className:`p-4 border-b border-gray-200 cursor-pointer ${l?.conversation_id===a.conversation_id?"bg-gray-100":"bg-white"}`,children:[(0,b.jsxs)("div",{className:"font-bold flex justify-between items-center",children:[a.other_user_name,(0,b.jsx)("span",{className:`text-sm ${i.has(a.other_user_id)?"text-green-500":"text-gray-500"}`,children:i.has(a.other_user_id)?"Online":"Offline"})]}),(0,b.jsx)("div",{className:"text-sm text-gray-600 truncate",children:a.last_message||"No messages yet"}),a.unread_count>0&&(0,b.jsx)("div",{className:"inline-flex items-center justify-center w-5 h-5 bg-red-500 text-white rounded-full text-xs mt-2",children:a.unread_count})]},a.conversation_id))]}),(0,b.jsx)("div",{className:"flex-1 flex flex-col",children:l?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"p-4 border-b border-gray-300 font-bold flex justify-between items-center",children:(0,b.jsxs)("div",{children:[l.other_user_name,(0,b.jsx)("span",{className:`text-sm ml-2 ${i.has(l.other_user_id)?"text-green-500":"text-gray-500"}`,children:i.has(l.other_user_id)?"Online":"Offline"})]})}),(0,b.jsxs)("div",{className:"flex-1 p-4 overflow-y-auto bg-gray-50",children:[e.map(c=>(0,b.jsx)("div",{className:`mb-3 flex ${c.sender_id===a?.id?"justify-end":"justify-start"}`,children:(0,b.jsxs)("div",{className:`max-w-xs px-3 py-2 rounded-2xl ${c.sender_id===a?.id?"bg-blue-500 text-white":"bg-gray-200 text-black"}`,children:[(0,b.jsx)("div",{children:c.content}),(0,b.jsx)("div",{className:"text-xs opacity-70 mt-1",children:new Date(c.created_at).toLocaleTimeString()})]})},c.id)),(0,b.jsx)("div",{ref:r})]}),(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),!n.trim()||!l||f(l.conversation_id,n.trim())&&(o(""),q(!1),l&&g(l.conversation_id,!1))},className:"p-4 border-t border-gray-300 flex",children:[(0,b.jsx)("input",{type:"text",value:n,onChange:a=>{var b;o(b=a.target.value),!p&&b.length>0&&(q(!0),l&&g(l.conversation_id,!0)),0===b.length&&(q(!1),l&&g(l.conversation_id,!1)),t.current&&clearTimeout(t.current),t.current=setTimeout(()=>{q(!1),l&&g(l.conversation_id,!1)},1e3)},placeholder:"Type a message...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-full mr-2"}),(0,b.jsx)("button",{type:"submit",disabled:!n.trim()||!d,className:`px-4 py-2 rounded-full text-white ${d?"bg-blue-500 hover:bg-blue-600":"bg-gray-400 cursor-not-allowed"}`,children:"Send"})]})]}):(0,b.jsx)("div",{className:"flex items-center justify-center h-full text-gray-600",children:"Select a conversation to start chatting"})})]}):(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsx)("div",{children:"Please login to access chat"})})}function u(){return(0,b.jsx)(r,{children:(0,b.jsx)(t,{})})}a.s(["default",()=>u],52763)}];

//# sourceMappingURL=app_chat_page_tsx_18691586._.js.map